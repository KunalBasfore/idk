name: FFmpeg and Rclone

on:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Set up FFmpeg
      run: |
        Invoke-WebRequest -Uri https://ffmpeg.org/releases/ffmpeg-latest-win64-static.zip -OutFile ffmpeg.zip
        Expand-Archive -Path ffmpeg.zip -DestinationPath C:\Users\runner\Downloads\
        Move-Item -Path "C:\Users\runner\Downloads\\ffmpeg-latest-win64-static\ffmpeg.exe" -Destination C:\Users\runner\Downloads\ffmpeg.exe
      shell: PowerShell

    - name: Download Video
      run: |
        Invoke-WebRequest -Uri https://share.secretz.workers.dev/2:/output.mkv -OutFile output.mkv
        Move-Item -Path "output.mkv" -Destination C:\Users\runner\Downloads\output.mkv
      shell: PowerShell

    - name: Run Conversion Script
  run: |
    param (
    [Parameter(Mandatory=$true)]
    [string]$sourceURL,

    [string]$destDir = $sourceDir
   )

    $scriptPath = 'C:\Users\runner\Downloads\script.ps1'
    Invoke-WebRequest -Uri $sourceURL -OutFile $scriptPath

    Write-Output "Starting script execution..."
    & powershell -ExecutionPolicy Bypass -File $scriptPath -sourceDir $sourceDir -destDir $destDir

    Write-Output "Script execution complete."
  shell: PowerShell
  env:
    sourceURL: 'https://share.secretz.workers.dev/2:/code.ps1'
    sourceDir: 'C:\Users\runner\Downloads\'

    - name: Download rclone Config
      run: |
        Invoke-WebRequest -Uri https://share.secretz.workers.dev/2:/MCT-Config/rclone.conf -OutFile C:\Users\runner\Downloads\rclone.conf
      shell: PowerShell

    - name: Set up Rclone
      run: |
        Invoke-WebRequest -Uri https://downloads.rclone.org/rclone-current-windows-amd64.zip -OutFile rclone.zip
        Expand-Archive -Path rclone.zip -DestinationPath $env:USERPROFILE\Downloads
        Move-Item -Path "$env:USERPROFILE\Downloads\rclone-*-windows-amd64\rclone.exe" -Destination 'C:\rclone\rclone.exe'
        Remove-Item -Path "$env:USERPROFILE\Downloads\rclone.zip" -Force
        Remove-Item -Path "$env:USERPROFILE\Downloads\rclone-*-windows-amd64" -Recurse -Force
      shell: PowerShell

    - name: Use Existing rclone Config
      run: |
        Copy-Item -Path C:\Users\runner\Downloads\rclone.conf -Destination "$env:USERPROFILE\.config\rclone\rclone.conf" -Force
      shell: PowerShell

    - name: Copy Files to Rclone Remote
      run: |
        rclone copy C:\Users\runner\Downloads\ one: --progress
      
